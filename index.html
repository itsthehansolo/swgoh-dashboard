<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGHDash</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0b0f19; /* Deep dark background */
        }
        
        /* Custom scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Mod status highlights */
        .mod-perfect { background-color: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .mod-missing { background-color: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        
        .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }

        /* Sortable header styles */
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: #374151 !important; color: #fbbf24; }

        /* Ensure content doesn't wrap unexpectedly, except for the Set column */
        .no-wrap { white-space: nowrap; }
    </style>
</head>
<body class="text-slate-300 min-h-screen">

    <div id="app" class="flex flex-col h-screen">
        <!-- Top Navigation Bar -->
        <header class="bg-[#0f172a] border-b border-slate-800 px-6 py-4 flex items-center justify-between">
            <div class="flex flex-col">
                <h1 class="text-2xl font-black text-yellow-500 tracking-tighter uppercase leading-none">SWGHDash</h1>
                <span id="build-id" class="text-[10px] text-slate-500 font-mono mt-1 uppercase tracking-widest">build_260212_234800</span>
            </div>

            <div class="flex items-center gap-6">
                <!-- Search Component -->
                <div class="relative">
                    <input 
                        type="text" 
                        id="character-search" 
                        placeholder="Search Characters..." 
                        class="search-input bg-[#1e293b] border border-slate-700 rounded px-4 py-1.5 text-sm w-64 text-slate-200 placeholder-slate-500 transition-all"
                    >
                </div>
            </div>
        </header>

        <!-- Sub-header/Breadcrumb Bar -->
        <div class="bg-[#1e293b] border-b border-slate-800 px-6 py-2">
            <nav id="menu" class="flex items-center gap-2 text-xs font-semibold text-slate-400">
                <!-- Menu links and separators injected by JS -->
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto p-6">
            <div class="bg-[#111827] rounded-lg border border-slate-800 shadow-2xl">
                <div class="overflow-x-auto">
                    <!-- Table auto-scales and distributes width -->
                    <table class="w-full text-left border-collapse table-auto">
                        <thead>
                            <tr id="table-header-row" class="text-slate-400 text-[10px] uppercase tracking-wider font-bold">
                                <!-- Headers injected by JS -->
                            </tr>
                        </thead>
                        <tbody id="unit-table-body" class="text-[13px] divide-y divide-slate-800/50">
                            <!-- Rows injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-[#0f172a] border-t border-slate-800 px-6 py-2 flex justify-center">
            <span class="text-[10px] text-slate-600 font-mono uppercase tracking-widest">build_260212_234800</span>
        </footer>
    </div>

    <script>
        let allUnits = []; 
        let currentSortCol = 'name';
        let currentSortDir = 'asc';

        // Column configuration
        const columns = [
            { label: 'Name', key: 'name', sortable: true },
            { label: 'Lvl', key: 'level', sortable: true, center: true },
            { label: 'Stars', key: 'stars', sortable: true, center: true },
            { label: 'Gear', key: 'gear', sortable: true, center: true },
            { label: 'Set', key: 'set', sortable: true },
            { label: 'Arrow', key: 'arrow', sortable: true },
            { label: 'Triangle', key: 'triangle', sortable: true },
            { label: 'Circle', key: 'circle', sortable: true },
            { label: 'Cross', key: 'cross', sortable: true },
            { label: 'Square', key: 'square', sortable: true },
            { label: 'Diamond', key: 'diamond', sortable: true },
            { label: 'Set(r)', key: 'set(r)', sortable: true, italic: true },
            { label: 'Arr(r)', key: 'arrow(r)', sortable: true, italic: true },
            { label: 'Tri(r)', key: 'triangle(r)', sortable: true, italic: true },
            { label: 'Cir(r)', key: 'circle(r)', sortable: true, italic: true },
            { label: 'Cro(r)', key: 'cross(r)', sortable: true, italic: true }
        ];

        /**
         * Formats mod stat names.
         * For 'Set' column, adds a line break only after a closing parenthesis followed by space.
         */
        function formatModText(text, addNewLine = false) {
            if (!text) return '-';
            let formatted = text
                .replace(/Critical Damage/gi, "Crit Damage")
                .replace(/Critical Chance/gi, "Crit Chance")
                .replace(/Critical Avoidance/gi, "Crit Avoidance");
            
            if (addNewLine) {
                // Only replace ") " with ")<br>" to avoid breaking inside parenthetical notes
                formatted = formatted.replace(/\)\s/g, ')<br>');
            }
            return formatted;
        }

        /**
         * Sort logic
         */
        function sortUnits(units, key, direction) {
            return [...units].sort((a, b) => {
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';

                if (key === 'gear') {
                    const getGearValue = (g) => {
                        if (typeof g !== 'string') return 0;
                        if (g.startsWith('R')) return 20 + parseInt(g.substring(1));
                        return parseInt(g) || 0;
                    };
                    valA = getGearValue(valA);
                    valB = getGearValue(valB);
                }

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }

                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
                
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
        }

        function handleHeaderClick(key) {
            if (currentSortCol === key) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortCol = key;
                currentSortDir = 'asc';
            }
            renderHeader();
            renderTable();
        }

        function renderHeader() {
            const headerRow = document.getElementById('table-header-row');
            headerRow.innerHTML = '';
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = `sticky top-0 z-10 bg-[#1f2937] p-3 border-b border-slate-800 no-wrap ${col.sortable ? 'sortable' : ''} ${col.center ? 'text-center' : ''} ${col.italic ? 'italic opacity-60' : ''}`;
                
                let indicator = (currentSortCol === col.key) ? (currentSortDir === 'asc' ? ' ▴' : ' ▾') : '';
                th.innerHTML = `${col.label}${indicator}`;
                
                if (col.sortable) th.onclick = () => handleHeaderClick(col.key);
                headerRow.appendChild(th);
            });
        }

        async function initDashboard() {
            try {
                const response = await fetch('swgoh_data.json');
                if (!response.ok) throw new Error('Could not find swgoh_data.json');
                const data = await response.json();
                
                allUnits = data.units || [];
                allUnits = sortUnits(allUnits, currentSortCol, currentSortDir);

                const menuContainer = document.getElementById('menu');
                const menuItems = data.menu || [];
                menuItems.push({ label: "Kyro", url: "https://trappedincarbonite.github.io/swghdash" });

                menuItems.forEach((item, index) => {
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.textContent = item.label;
                    a.className = "hover:text-blue-400 transition-colors uppercase no-wrap";
                    menuContainer.appendChild(a);
                    if (index < menuItems.length - 1) {
                        const sep = document.createElement('span');
                        sep.textContent = " | ";
                        sep.className = "text-slate-600 font-normal px-1";
                        menuContainer.appendChild(sep);
                    }
                });

                renderHeader();
                renderTable();

                document.getElementById('character-search').addEventListener('input', () => renderTable());

            } catch (err) {
                console.error("Init Error:", err);
                document.getElementById('unit-table-body').innerHTML = `<tr><td colspan="16" class="p-10 text-center text-red-400">Error: ${err.message}</td></tr>`;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('unit-table-body');
            const searchQuery = document.getElementById('character-search').value.toLowerCase();
            
            let displayUnits = allUnits.filter(u => u.name.toLowerCase().includes(searchQuery));
            displayUnits = sortUnits(displayUnits, currentSortCol, currentSortDir);

            tbody.innerHTML = '';

            displayUnits.forEach(unit => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/40 transition-colors border-l-2 border-transparent hover:border-yellow-500/50";

                const getStyle = (current, recommended) => {
                    if (!recommended || recommended === "") return "text-slate-500";
                    if (!current || current === "") return "mod-missing rounded px-1 no-wrap";
                    return current.toLowerCase().includes(recommended.toLowerCase()) 
                        ? "mod-perfect rounded px-1 font-semibold no-wrap" 
                        : "mod-missing rounded px-1 no-wrap";
                };

                // Gear bolding logic
                let gearStyle = "text-slate-400 font-bold no-wrap"; 
                if (unit.gear?.startsWith('R')) {
                    const rLevel = parseInt(unit.gear.replace('R', ''));
                    gearStyle = rLevel >= 7 ? "text-amber-400 font-bold no-wrap" : "text-blue-400 font-bold no-wrap";
                }

                const vSquareStyle = (unit.v_square_speed === "yes") ? "mod-perfect rounded px-1 no-wrap" : "text-slate-500 no-wrap";
                const vDiamondStyle = (unit.v_diamond_speed === "yes") ? "mod-perfect rounded px-1 no-wrap" : "text-slate-500 no-wrap";

                tr.innerHTML = `
                    <td class="p-3 no-wrap">
                        <a href="${unit.url}" target="_blank" class="font-bold text-slate-100 hover:text-blue-400 transition-colors">${unit.name}</a>
                    </td>
                    <td class="p-3 text-center text-slate-500 font-mono font-bold no-wrap">${unit.level}</td>
                    <td class="p-3 text-center font-bold no-wrap ${unit.stars === 7 ? 'text-amber-500' : 'text-slate-400'}">${unit.stars}</td>
                    <td class="p-3 text-center ${gearStyle}">${unit.gear}</td>
                    
                    <!-- Set column allows breaks, others stay no-wrap -->
                    <td class="p-3 bg-slate-900/20 leading-tight"><span class="${getStyle(unit.set, unit['set(r)']).replace('no-wrap', '')}">${formatModText(unit.set, true)}</span></td>
                    <td class="p-3 bg-slate-900/20 leading-tight no-wrap"><span class="${getStyle(unit.arrow, unit['arrow(r)'])}">${formatModText(unit.arrow, false)}</span></td>
                    <td class="p-3 bg-slate-900/20 leading-tight no-wrap"><span class="${getStyle(unit.triangle, unit['triangle(r)'])}">${formatModText(unit.triangle, false)}</span></td>
                    <td class="p-3 bg-slate-900/20 leading-tight no-wrap"><span class="${getStyle(unit.circle, unit['circle(r)'])}">${formatModText(unit.circle, false)}</span></td>
                    <td class="p-3 bg-slate-900/20 leading-tight no-wrap"><span class="${getStyle(unit.cross, unit['cross(r)'])}">${formatModText(unit.cross, false)}</span></td>
                    
                    <td class="p-3 no-wrap"><span class="${vSquareStyle}">${formatModText(unit.square, false)}</span></td>
                    <td class="p-3 no-wrap"><span class="${vDiamondStyle}">${formatModText(unit.diamond, false)}</span></td>
                    
                    <!-- Recommended values -->
                    <td class="p-3 text-slate-500 italic text-[11px] leading-tight">${formatModText(unit['set(r)'], true)}</td>
                    <td class="p-3 text-slate-500 italic text-[11px] leading-tight no-wrap">${formatModText(unit['arrow(r)'], false)}</td>
                    <td class="p-3 text-slate-500 italic text-[11px] leading-tight no-wrap">${formatModText(unit['triangle(r)'], false)}</td>
                    <td class="p-3 text-slate-500 italic text-[11px] leading-tight no-wrap">${formatModText(unit['circle(r)'], false)}</td>
                    <td class="p-3 text-slate-500 italic text-[11px] leading-tight no-wrap">${formatModText(unit['cross(r)'], false)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
